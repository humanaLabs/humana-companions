# üîó Gerenciamento de Funcionalidades Compartilhadas

## üéØ Vis√£o Geral

Este documento define como gerenciar, desenvolver e manter funcionalidades compartilhadas na plataforma Humana Companions, garantindo reutiliza√ß√£o eficiente, manutenibilidade e consist√™ncia em toda a aplica√ß√£o.

## üìÅ Estrutura Atual de Funcionalidades Compartilhadas

### **Mapeamento da Organiza√ß√£o Existente**

```
funcionalidades-compartilhadas/
‚îú‚îÄ‚îÄ üé® Design System (components/ui/)
‚îÇ   ‚îú‚îÄ‚îÄ button.tsx, input.tsx, select.tsx
‚îÇ   ‚îú‚îÄ‚îÄ dialog.tsx, sheet.tsx, dropdown-menu.tsx
‚îÇ   ‚îî‚îÄ‚îÄ sidebar.tsx (24KB - componente complexo)
‚îú‚îÄ‚îÄ üîê Autentica√ß√£o & Permiss√µes (lib/auth/, hooks/use-permissions.tsx)
‚îÇ   ‚îú‚îÄ‚îÄ Sistema RBAC granular (30+ permiss√µes)
‚îÇ   ‚îú‚îÄ‚îÄ Context Provider com 244 linhas
‚îÇ   ‚îî‚îÄ‚îÄ Hooks espec√≠ficos por caso de uso
‚îú‚îÄ‚îÄ üóÑÔ∏è Banco de Dados (lib/db/)
‚îÇ   ‚îú‚îÄ‚îÄ Schema com 18 migrations
‚îÇ   ‚îú‚îÄ‚îÄ Queries reutiliz√°veis
‚îÇ   ‚îî‚îÄ‚îÄ Helpers de transforma√ß√£o
‚îú‚îÄ‚îÄ ü§ñ AI & LLM (lib/ai/)
‚îÇ   ‚îú‚îÄ‚îÄ Integra√ß√£o multi-provider
‚îÇ   ‚îú‚îÄ‚îÄ Tools compartilhados
‚îÇ   ‚îî‚îÄ‚îÄ Prompt management
‚îú‚îÄ‚îÄ üß© Componentes de Neg√≥cio
‚îÇ   ‚îú‚îÄ‚îÄ page-header.tsx (padr√£o de layout)
‚îÇ   ‚îú‚îÄ‚îÄ companion-*.tsx (gest√£o de companions)
‚îÇ   ‚îú‚îÄ‚îÄ organization-*.tsx (multi-tenancy)
‚îÇ   ‚îî‚îÄ‚îÄ chat.tsx (14KB - core da aplica√ß√£o)
‚îú‚îÄ‚îÄ üé£ Hooks Customizados
‚îÇ   ‚îú‚îÄ‚îÄ use-permissions.tsx (sistema completo)
‚îÇ   ‚îú‚îÄ‚îÄ use-mobile.tsx, use-scroll-to-bottom.tsx
‚îÇ   ‚îî‚îÄ‚îÄ use-chat-visibility.ts
‚îî‚îÄ‚îÄ üõ†Ô∏è Utilit√°rios (lib/utils.ts, lib/types.ts)
    ‚îú‚îÄ‚îÄ Fetch com error handling
    ‚îú‚îÄ‚îÄ Tipos TypeScript compartilhados
    ‚îî‚îÄ‚îÄ Fun√ß√µes auxiliares
```

## üèóÔ∏è Arquitetura de Funcionalidades Compartilhadas

### **1. Hierarquia de Depend√™ncias**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           UI Components             ‚îÇ ‚Üê Mais espec√≠fico
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ        Business Components          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ            Custom Hooks             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ          Shared Services            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           Core Utilities            ‚îÇ ‚Üê Mais gen√©rico
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **2. Padr√µes de Implementa√ß√£o Atuais**

#### **A. Design System (Base)**
O projeto usa shadcn/ui como foundation com extens√µes customizadas:

- **Componentes Base**: `components/ui/` com 17 componentes
- **Padr√£o de Props**: Variants, sizes, className para customiza√ß√£o
- **Composi√ß√£o**: Componentes compostos como `sidebar.tsx` (775 linhas)

#### **B. Sistema de Permiss√µes Robusto**
Funcionalidade compartilhada mais complexa do projeto:

- **Context Provider**: 244 linhas com estado global
- **Hooks Especializados**: `useCanAccess`, `useHasPermission`, `useIsAdmin`
- **30+ Permiss√µes**: Sistema RBAC granular
- **Multi-tenancy**: Suporte a organiza√ß√µes e teams

#### **C. Padr√µes de Layout Consistentes**
- **PageHeader**: Componente padronizado para todas as p√°ginas
- **Responsive Design**: Integra√ß√£o com sidebar responsivo
- **Design Tokens**: Uso consistente de classes Tailwind

### **3. Tipos e Interfaces Centralizadas**

O arquivo `lib/types.ts` define estruturas cr√≠ticas:
- **CompanionStructure**: Schema completo para companions
- **OrganizationStructure**: Multi-tenancy e hierarquia
- **Interfaces de AI**: Padroniza√ß√£o de modelos e providers

## üîß Processo de Desenvolvimento

### **1. Identifica√ß√£o de Funcionalidades Compartilhadas**

#### **Crit√©rios para Compartilhamento:**
- ‚úÖ **Uso em 3+ locais** diferentes
- ‚úÖ **L√≥gica de neg√≥cio consistente** entre usos
- ‚úÖ **Interface est√°vel** (n√£o muda frequentemente)
- ‚úÖ **Benef√≠cio > Custo** de abstra√ß√£o

#### **Red Flags - N√ÉO Compartilhar:**
- ‚ùå Usado apenas 1-2 vezes
- ‚ùå L√≥gica muito espec√≠fica para um contexto
- ‚ùå Interface inst√°vel (ainda experimentando)
- ‚ùå Over-engineering prematuro

### **2. Processo de Cria√ß√£o**

#### **Passo 1: An√°lise de Uso**
- Buscar por padr√µes repetidos nos diret√≥rios `app/` e `components/`
- Identificar varia√ß√µes e casos edge
- Mapear diferentes usos da mesma funcionalidade

#### **Passo 2: Design da Interface**
- Definir interface gen√©rica mas √∫til
- Props obrigat√≥rias (core functionality)
- Props opcionais (customiza√ß√£o)
- Escape hatches para casos especiais
- Suporte a className e children para extensibilidade

#### **Passo 3: Implementa√ß√£o Incremental**
1. **MVP**: Implementar caso mais simples
2. **Extens√£o**: Adicionar varia√ß√µes necess√°rias
3. **Refinamento**: Otimizar interface baseado no uso real

### **3. Padr√µes de Organiza√ß√£o**

#### **Estrutura Atual (Por Camada)**
- **lib/**: L√≥gica pura, sem UI (auth, db, ai, utils)
- **components/**: UI Components (ui, auth, experimental, providers)
- **hooks/**: React hooks (permissions, mobile, espec√≠ficos)
- **Organiza√ß√£o clara** por responsabilidade e camada de abstra√ß√£o

## üéõÔ∏è Gerenciamento de Estado Compartilhado

### **1. Context Providers (Estado Global)**

#### **Exemplo Real: Sistema de Permiss√µes**
- **Interface completa** com userPermissions, loading, valida√ß√µes
- **Hooks especializados** para casos espec√≠ficos (canAccess, hasPermission, isAdmin)
- **Context Provider robusto** com 244 linhas bem estruturadas
- **Cache e error handling** integrados
- **Multi-tenancy support** com organiza√ß√µes e teams

#### **Hooks Especializados Existentes**
- **useCanAccess**: Verifica√ß√£o espec√≠fica de resource + action
- **useHasPermission**: Valida√ß√£o de permiss√£o individual
- **useIsAdmin / useIsMasterAdmin**: Verifica√ß√µes de role
- **useAdminAccess**: Conjunto de permiss√µes administrativas
- **Padr√£o consistente** de nomenclatura e funcionamento

### **2. Utilit√°rios Compartilhados**

#### **Error Handling Centralizado**
- **Fetcher unificado** com tratamento de erros padr√£o
- **ChatSDKError** personalizado para diferentes tipos de erro
- **Offline detection** integrado
- **Valida√ß√£o autom√°tica** de response status
- **JSON parsing** com error handling

#### **Fun√ß√µes Auxiliares**
- **cn()**: Merge inteligente de classes CSS (clsx + tailwind-merge)
- **generateUUID()**: Gera√ß√£o de IDs √∫nicos padronizada
- **getMostRecentUserMessage()**: Helpers espec√≠ficos de chat
- **sanitizeText()**: Limpeza e sanitiza√ß√£o de texto
- **Utilit√°rios de localStorage** com error handling

## üîÑ Ciclo de Vida e Manuten√ß√£o

### **1. An√°lise de Estado Atual**

#### **Funcionalidades Maduras** (Est√°veis)
- ‚úÖ Sistema de Permiss√µes (use-permissions.tsx)
- ‚úÖ Design System Base (components/ui/)
- ‚úÖ PageHeader Component
- ‚úÖ Utilit√°rios Core (lib/utils.ts)

#### **Funcionalidades em Evolu√ß√£o** (Cuidado)
- ‚ö†Ô∏è Sistema de AI/LLM (m√∫ltiplos providers)
- ‚ö†Ô∏è Componentes de Chat (chat.tsx com 434 linhas)
- ‚ö†Ô∏è Componentes Experimentais (components/experimental/)

#### **Oportunidades de Refatora√ß√£o**
- üîÑ M√∫ltiplos seletores similares (model-selector, companion-selector, mcp-selector)
- üîÑ Formul√°rios repetitivos (organization-form, companion-form)
- üîÑ Modais administrativos (create-*-modal.tsx)

### **2. Estrat√©gias de Manuten√ß√£o**

#### **Versionamento Sem√¢ntico**
- **v1**: Interface simples com props essenciais
- **v2**: Adicionar features mantendo backward compatibility
- **v3**: Breaking changes com nova major version
- **Estrat√©gia incremental** para evolu√ß√£o de APIs
- **Documenta√ß√£o de migration** para breaking changes

#### **Depreca√ß√£o Gradual**
- **Fase 1**: Marcar como deprecated com warnings
- **Fase 2**: Co-exist√™ncia de old e new functions
- **Fase 3**: Remo√ß√£o completa da vers√£o antiga
- **Timeline claro** para cada fase de depreca√ß√£o
- **Ferramentas automatizadas** para detectar uso de APIs deprecated

## üìä M√©tricas e Monitoramento

### **1. Indicadores de Qualidade Atual**

#### **Complexidade de Componentes**
- **sidebar.tsx**: 775 linhas (complexo demais?)
- **companion-form.tsx**: 31KB (precisa quebrar?)
- **organization-form-fields.tsx**: 482 linhas (candidato a refatora√ß√£o)

#### **Reutiliza√ß√£o**
- **page-header.tsx**: Usado em 15+ p√°ginas ‚úÖ
- **use-permissions.tsx**: Core de toda autoriza√ß√£o ‚úÖ
- **Componentes ui/**: Base de todo design system ‚úÖ

### **2. Oportunidades de Melhoria**

#### **Consolida√ß√£o de Seletores**
- **GenericSelector<T>** para substituir 4+ seletores similares
- **Redu√ß√£o estimada**: 60% de c√≥digo duplicado
- **Funcionalidades comuns**: Loading, grouping, search, validation
- **Customiza√ß√£o preservada** via render props e configurations

#### **Form Builder Gen√©rico**
- **Consolida√ß√£o de formul√°rios** similares (organization, companion, mcp-server)
- **Schema-driven forms** com valida√ß√£o autom√°tica
- **Componentes reutiliz√°veis** para diferentes tipos de input
- **Redu√ß√£o de complexidade** em forms grandes (31KB ‚Üí m√≥dulos menores)

## üöÄ Roadmap de Melhorias

### **Prioridade 1 (Pr√≥ximas 4 semanas)**
1. **Auditoria de Componentes Grandes**
   - Quebrar `sidebar.tsx` (775 linhas)
   - Refatorar `companion-form.tsx` (31KB)
   - Modularizar `organization-form-fields.tsx`

2. **Consolida√ß√£o de Seletores**
   - Criar `GenericSelector<T>` component
   - Migrar 4+ seletores existentes
   - Reduzir c√≥digo duplicado em 60%+

### **Prioridade 2 (2-3 meses)**
1. **Form Builder System**
   - Generic form components
   - Validation system compartilhado
   - Auto-generation baseado em schema

2. **Design System Evolution**
   - Storybook para componentes
   - Design tokens refinados
   - Component composition patterns

### **Prioridade 3 (Long-term)**
1. **Performance Optimization**
   - Bundle splitting por funcionalidade
   - Lazy loading de componentes pesados
   - Memoization estrat√©gica

2. **Developer Experience**
   - Type-safe builders
   - CLI tools para gera√ß√£o
   - Linting rules customizadas

## üìù Checklist para Desenvolvimento

### **Antes de Criar Nova Funcionalidade:**
- [ ] Existe componente similar que pode ser estendido?
- [ ] A funcionalidade ser√° usada em 3+ locais?
- [ ] A interface √© est√°vel e bem definida?
- [ ] O benef√≠cio justifica a complexidade adicional?

### **Durante o Desenvolvimento:**
- [ ] Interface TypeScript bem definida
- [ ] Props com defaults sensatos
- [ ] Seguir padr√µes existentes (ex: PageHeader pattern)
- [ ] Escape hatches para casos especiais
- [ ] Documenta√ß√£o b√°sica

### **Ap√≥s Implementa√ß√£o:**
- [ ] Refatorar usos existentes para a nova funcionalidade
- [ ] Monitorar performance impact
- [ ] Coletar feedback dos desenvolvedores
- [ ] Considerar migra√ß√£o de componentes similares

## üéØ Conclus√µes

### **Pontos Fortes Atuais**
- ‚úÖ Sistema de permiss√µes robusto e bem estruturado
- ‚úÖ Design system consistente (shadcn/ui)
- ‚úÖ Padr√µes de layout bem definidos
- ‚úÖ TypeScript types centralizados

### **√Åreas de Melhoria**
- üîÑ Componentes muito grandes (quebrar em m√≥dulos menores)
- üîÑ Duplica√ß√£o de padr√µes (seletores, formul√°rios)
- üîÑ Funcionalidades experimentais precisam de estrutura
- üîÑ Documenta√ß√£o de componentes complexos

### **Pr√≥ximos Passos**
1. **Refatora√ß√£o de componentes grandes** (4 semanas)
2. **Consolida√ß√£o de padr√µes repetidos** (8 semanas)
3. **Sistema de form builder gen√©rico** (12 semanas)
4. **Evolu√ß√£o do design system** (16 semanas)

---

*Este documento reflete o estado atual (Dezembro 2024) e deve ser atualizado conforme a evolu√ß√£o da arquitetura.* 
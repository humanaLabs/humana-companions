# ü§ñ Fundamentos do AI SDK - Guia de Implementa√ß√£o

## üìã Vis√£o Geral

Este documento extrai os conceitos fundamentais do AI SDK baseado na documenta√ß√£o oficial em `.cursor/docs/ai-sdk-docs`, focando na implementa√ß√£o pr√°tica dentro da nossa aplica√ß√£o.

> **üìç Fonte:** Baseado em `.cursor/docs/ai-sdk-docs/02-foundations/` e `.cursor/docs/ai-sdk-docs/02-guides/`

## üéØ Conceitos Fundamentais

### **üß† 1. Large Language Models (LLMs)**

Um **LLM** √© um modelo focado em **texto** que:
- Recebe uma sequ√™ncia de palavras como entrada
- Prediz a sequ√™ncia mais prov√°vel como continua√ß√£o
- Atribui probabilidades a poss√≠veis pr√≥ximas sequ√™ncias
- Continua gerando at√© atingir um crit√©rio de parada

#### **‚ö†Ô∏è Limita√ß√µes Importantes:**
- **Hallucination** - pode inventar informa√ß√µes n√£o presentes no treinamento
- **Knowledge Cutoff** - limitado aos dados de treinamento
- **Context Window** - limita√ß√£o de tokens por requisi√ß√£o

### **üîó 2. Embedding Models**

Modelos que convertem dados complexos em **vetores densos**:
- **N√£o geram** novo conte√∫do
- **Representam** rela√ß√µes sem√¢nticas e sint√°ticas
- **Usados para** busca sem√¢ntica, RAG, clustering

### **üîÑ 3. Streaming**

Resposta em tempo real ao inv√©s de esperar resposta completa:
```typescript
// Exemplo de streaming na nossa aplica√ß√£o
const result = await streamText({
  model: openai('gpt-4-turbo'),
  prompt: 'Explique conceitos de IA',
  onChunk: (chunk) => {
    // Atualiza UI em tempo real
    updateChatUI(chunk.text);
  },
});
```

### **üõ†Ô∏è 4. Tools (Function Calling)**

Permite que LLMs executem fun√ß√µes espec√≠ficas:
```typescript
// Exemplo das nossas tools
const tools = {
  createDocument: {
    description: 'Cria um novo documento/artifact',
    parameters: z.object({
      title: z.string(),
      content: z.string(),
      type: z.enum(['text', 'code', 'image', 'sheet']),
    }),
    execute: async ({ title, content, type }) => {
      return await createDocument({ title, content, type });
    },
  },
  updateDocument: {
    description: 'Atualiza documento existente',
    parameters: z.object({
      id: z.string(),
      content: z.string(),
    }),
    execute: async ({ id, content }) => {
      return await updateDocument(id, content);
    },
  },
};
```

## üèóÔ∏è Implementa√ß√£o na Nossa Aplica√ß√£o

### **üìÅ Estrutura do AI SDK na Aplica√ß√£o:**

```
üìÅ lib/ai/
‚îú‚îÄ‚îÄ models.ts              # Configura√ß√£o de modelos
‚îú‚îÄ‚îÄ providers.ts           # Providers (OpenAI, Anthropic)
‚îú‚îÄ‚îÄ prompts.ts             # Templates de prompts
‚îú‚îÄ‚îÄ tools/                 # Function calling
‚îÇ   ‚îú‚îÄ‚îÄ create-document.ts
‚îÇ   ‚îú‚îÄ‚îÄ update-document.ts
‚îÇ   ‚îú‚îÄ‚îÄ get-weather.ts
‚îÇ   ‚îî‚îÄ‚îÄ request-suggestions.ts
‚îî‚îÄ‚îÄ dify-agents.ts         # Integra√ß√£o Dify
```

### **üîß 1. Configura√ß√£o de Providers**

```typescript
// lib/ai/providers.ts
import { openai } from '@ai-sdk/openai';
import { anthropic } from '@ai-sdk/anthropic';

export const providers = {
  openai: {
    'gpt-4-turbo': openai('gpt-4-turbo'),
    'gpt-4o': openai('gpt-4o'),
    'gpt-4o-mini': openai('gpt-4o-mini'),
  },
  anthropic: {
    'claude-3-5-sonnet': anthropic('claude-3-5-sonnet-20241022'),
    'claude-3-5-haiku': anthropic('claude-3-5-haiku-20241022'),
  },
};
```

### **üîß 2. Configura√ß√£o de Modelos**

```typescript
// lib/ai/models.ts
export interface ModelConfig {
  id: string;
  provider: 'openai' | 'anthropic';
  name: string;
  description: string;
  maxTokens: number;
  supportsTools: boolean;
  supportsVision: boolean;
}

export const models: ModelConfig[] = [
  {
    id: 'gpt-4-turbo',
    provider: 'openai',
    name: 'GPT-4 Turbo',
    description: 'Modelo mais avan√ßado para tarefas complexas',
    maxTokens: 128000,
    supportsTools: true,
    supportsVision: true,
  },
  // ... outros modelos
];
```

### **üîß 3. Implementa√ß√£o de Streaming**

```typescript
// app/(chat)/api/chat/route.ts
import { streamText } from 'ai';
import { providers } from '@/lib/ai/providers';

export async function POST(request: Request) {
  const { messages, model } = await request.json();
  
  const result = await streamText({
    model: providers.openai[model],
    messages,
    tools: {
      createDocument,
      updateDocument,
      getWeather,
      requestSuggestions,
    },
    onFinish: async ({ text, usage }) => {
      // Salva no banco de dados
      await saveChatMessage({
        content: text,
        tokens: usage.totalTokens,
      });
    },
  });

  return result.toDataStreamResponse();
}
```

### **üîß 4. Tools Implementation**

```typescript
// lib/ai/tools/create-document.ts
import { z } from 'zod';
import { tool } from 'ai';

export const createDocument = tool({
  description: 'Cria um novo documento ou artifact',
  parameters: z.object({
    title: z.string().describe('T√≠tulo do documento'),
    content: z.string().describe('Conte√∫do do documento'),
    type: z.enum(['text', 'code', 'image', 'sheet']).describe('Tipo do documento'),
  }),
  execute: async ({ title, content, type }) => {
    const document = await db.insert(documents).values({
      title,
      content,
      kind: type,
      userId: getCurrentUserId(),
    }).returning();

    return {
      success: true,
      documentId: document[0].id,
      message: `Documento "${title}" criado com sucesso`,
    };
  },
});
```

## üéØ Padr√µes de Implementa√ß√£o

### **üìù 1. Prompt Engineering**

```typescript
// lib/ai/prompts.ts
export const systemPrompts = {
  assistant: `Voc√™ √© um assistente IA especializado em criar e editar documentos.

Diretrizes:
- SEMPRE use as tools dispon√≠veis quando apropriado
- Para c√≥digo, especifique a linguagem corretamente
- Para documentos longos, divida em se√ß√µes
- Mantenha formata√ß√£o consistente

Tools dispon√≠veis:
- createDocument: Para criar novos artifacts  
- updateDocument: Para editar artifacts existentes
- getWeather: Para informa√ß√µes meteorol√≥gicas
- requestSuggestions: Para sugest√µes de melhoria`,

  codeReview: `Voc√™ √© um especialista em revis√£o de c√≥digo.

Analise o c√≥digo fornecido e:
1. Identifique problemas de seguran√ßa
2. Sugira melhorias de performance
3. Verifique boas pr√°ticas
4. Forne√ßa exemplos de corre√ß√£o

Use a tool updateDocument para aplicar corre√ß√µes.`,
};
```

### **üìù 2. Error Handling**

```typescript
// lib/ai/error-handling.ts
export async function handleAIError(error: unknown) {
  if (error instanceof Error) {
    switch (error.name) {
      case 'AI_APICallError':
        return {
          type: 'api_error',
          message: 'Erro na API do provedor de IA',
          retry: true,
        };
      case 'AI_InvalidPromptError':
        return {
          type: 'prompt_error', 
          message: 'Prompt inv√°lido ou muito longo',
          retry: false,
        };
      case 'AI_RateLimitError':
        return {
          type: 'rate_limit',
          message: 'Limite de requisi√ß√µes atingido',
          retry: true,
          retryAfter: 60,
        };
      default:
        return {
          type: 'unknown_error',
          message: 'Erro desconhecido na IA',
          retry: false,
        };
    }
  }
}
```

### **üìù 3. Usage Tracking**

```typescript
// lib/ai/usage-tracking.ts
export async function trackUsage(params: {
  userId: string;
  model: string;
  promptTokens: number;
  completionTokens: number;
  cost?: number;
}) {
  await db.insert(aiUsage).values({
    userId: params.userId,
    model: params.model,
    promptTokens: params.promptTokens,
    completionTokens: params.completionTokens,
    totalTokens: params.promptTokens + params.completionTokens,
    cost: params.cost,
    timestamp: new Date(),
  });
}
```

## üîÑ RAG (Retrieval Augmented Generation)

### **üéØ Conceito:**
RAG = **Recupera√ß√£o** + **Gera√ß√£o Aumentada**
- Busca informa√ß√µes relevantes no knowledge base
- Fornece contexto espec√≠fico para o LLM
- Reduz hallucinations e melhora precis√£o

### **üèóÔ∏è Implementa√ß√£o RAG:**

```typescript
// lib/ai/rag.ts
export async function performRAG(query: string) {
  // 1. Gerar embedding da query
  const queryEmbedding = await embed({
    model: openai.embedding('text-embedding-3-small'),
    value: query,
  });

  // 2. Buscar documentos similares
  const similarDocuments = await db
    .select()
    .from(embeddings)
    .where(
      sql`${embeddings.embedding} <-> ${queryEmbedding.embedding} < 0.5`
    )
    .orderBy(
      sql`${embeddings.embedding} <-> ${queryEmbedding.embedding}`
    )
    .limit(5);

  // 3. Construir contexto
  const context = similarDocuments
    .map(doc => doc.content)
    .join('\n\n');

  // 4. Gerar resposta com contexto
  const result = await generateText({
    model: openai('gpt-4-turbo'),
    prompt: `Contexto: ${context}\n\nPergunta: ${query}`,
  });

  return result.text;
}
```

## üéØ Melhores Pr√°ticas

### **‚úÖ Do's:**
1. **Use streaming** para melhor UX
2. **Implemente tools** para funcionalidades espec√≠ficas  
3. **Track usage** para monitoramento
4. **Handle errors** graciosamente
5. **Validate inputs** antes de enviar para IA
6. **Cache responses** quando apropriado

### **‚ùå Don'ts:**
1. **N√£o confie cegamente** nas respostas da IA
2. **N√£o ignore rate limits** dos providers
3. **N√£o exponha API keys** no frontend
4. **N√£o processe dados sens√≠veis** sem criptografia
5. **N√£o fa√ßa prompts muito longos** sem necessidade

## üîó Integra√ß√£o com Dify

Nossa aplica√ß√£o tamb√©m integra com **Dify** para agentes especializados:

```typescript
// lib/ai/dify-agents.ts
export async function callDifyAgent(agentId: string, message: string) {
  const response = await fetch(`${DIFY_API_BASE}/chat-messages`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${DIFY_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      inputs: {},
      query: message,
      response_mode: 'streaming',
      conversation_id: '',
      user: getCurrentUserId(),
    }),
  });

  return response.body;
}
```

---

## üéØ Resumo dos Fundamentos

1. **LLMs** - Modelos de texto com limita√ß√µes conhecidas
2. **Embeddings** - Representa√ß√£o vetorial para busca sem√¢ntica  
3. **Streaming** - Resposta em tempo real
4. **Tools** - Function calling para a√ß√µes espec√≠ficas
5. **RAG** - Conhecimento externo para reduzir hallucinations
6. **Error Handling** - Tratamento robusto de erros
7. **Usage Tracking** - Monitoramento de uso e custos

**üí° O AI SDK abstrai a complexidade de diferentes providers, permitindo foco na l√≥gica de neg√≥cio!** üöÄ‚ú® 